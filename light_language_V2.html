<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>光語言感知 _ 主觀感受問卷調查</title>
<style>
:root{
  --bg:#0b0d10; --text:#e6edf3; --muted:#9aa4b2; --card:#0f141a; --border:#243141; --accent:#6aa6ff;
  --wall-left:5%;  --wall-top:5%;    --wall-w:90%;  --wall-h:90%;
  --lamp-left:39%;  --lamp-top:29%;   --lamp-w:15%;  --lamp-h:10%;
  --spot-left:47%;  --spot-top:86%;   --spot-w:40%;  --spot-h:22%;
  --cone-h:70%;     --cone-blur:2.2vw; --spot-blur:1.5vw; --wall-blur:3vw; --lamp-blur:.2vw;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:"Noto Sans TC",ui-sans-serif,system-ui;}
h1{font-size:28px;margin:24px auto 6px;max-width:1100px;padding:0 16px;font-weight:800}
.container{max-width:1100px;margin:0 auto;padding:0 16px 40px}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;margin:16px 0}
.row{display:flex;gap:16px;flex-wrap:wrap}
.field{flex:1 1 300px}
label{display:block;margin:8px 0 6px}
select{width:100%;padding:12px;border:1px solid #2a394b;border-radius:8px;background:#121721;color:var(--text);font-size:18px}
.btnbar{display:flex;justify-content:space-between;gap:16px;margin-top:16px}
.btn{padding:10px 16px;border:1px solid var(--border);border-radius:12px;background:#141c26;color:var(--text);cursor:pointer}
.btn.primary{background:var(--accent);color:#0b1220;font-weight:700}
.btn:disabled{opacity:.5;cursor:not-allowed}

/* 提醒膠囊（不顯示情境名稱） */
.badge{
  display:inline-block;background:#121923;border:1px solid #233142;border-radius:12px;
  padding:10px 14px;color:#cbd6e2;font-size:17px;font-weight:600;line-height:1.45;
  max-width:100%;white-space:normal;
}

/* 舞台 */
.stage{position:relative;width:100%;aspect-ratio:16/9;border:1px solid var(--border);border-radius:16px;overflow:hidden;background:#0a0f15}
.stage img.base{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:contrast(1.04) brightness(.96)}
.overlay{position:absolute;inset:0;pointer-events:none}

/* 光層 */
/* 牆面漫射（改成大畫布 + 讓漸層自己是圓形） */
.wall{
  position:absolute;
  /* 放大畫布，避免邊界造成亮度堆積；居中稍往上 */
  left:-15%; top:-18%;  width:130%; height:85%;  mix-blend-mode:screen;  filter:blur(var(--wall-blur));  opacity:0;  border-radius:0;}
.cone{position:absolute;left:0;bottom:-5%;width:100%;height:var(--cone-h);background: radial-gradient(72% 82% at 55% 88%, rgba(255, 255, 255, 0.35), rgba(0, 0, 0, 0) 100%);mix-blend-mode:screen;filter:blur(var(--cone-blur));opacity:0;transform-origin:50% 90%}
.spot{position:absolute;left:var(--spot-left);top:var(--spot-top);width:var(--spot-w);height:var(--spot-h);transform:translate(-50%,-50%) rotate(-10deg);transform-origin:center;border-radius:50%;mix-blend-mode:screen;filter:blur(var(--spot-blur));opacity:0}
.lamp{position:absolute;left:var(--lamp-left);top:var(--lamp-top);width:var(--lamp-w);height:var(--lamp-h);border-radius:50%;transform:rotate(-22deg);mix-blend-mode:screen;opacity:.6}
.lamp::before{content:"";position:absolute;inset:-10% -15%;border-radius:50%;filter:blur(var(--lamp-blur));background:radial-gradient(closest-side,rgba(255,255,255,.9),rgba(255,255,255,0))}
.drawer{position:absolute;left:10%;right:10%;bottom:5%;height:10%;background:radial-gradient(50% 120% at 50% 0%,rgba(255,255,255,.25),rgba(255,255,255,0) 80%);mix-blend-mode:screen;filter:blur(.8vw);opacity:0}

/* timebar */
.timewrap{height:8px;background:#111821;border:1px solid #223142;border-radius:999px;overflow:hidden;margin-top:10px}
.timebar{height:100%;width:0%;background:linear-gradient(90deg,#6aa6ff,#9ed2ff)}

/* Likert */
.likert-row{margin:26px 0 32px;text-align:center}
.likert-head{margin-bottom:10px;font-size:16px;font-weight:500;text-align:center}
.scale-wrap{display:grid;grid-template-columns:auto 1fr auto;align-items:center;justify-items:center;gap:18px;width:fit-content;margin:0 auto}
.scale{display:flex;gap:10px;justify-content:center;align-items:center}
.scale label{display:flex;flex-direction:column;align-items:center;gap:3px}
.scale input[type="radio"]{appearance:none;width:22px;height:22px;border:2px solid #4a5568;border-radius:50%;background:transparent;transition:.2s;cursor:pointer}
.scale input[type="radio"]:hover{border-color:var(--accent);box-shadow:0 0 3px var(--accent)}
.scale input[type="radio"]:checked{background:var(--accent);border-color:var(--accent)}
.scale span{font-size:12px;color:var(--muted)}
.scale-wrap .end-label{font-size:14px;color:var(--muted);white-space:nowrap;align-self:center}

/* 窄螢幕保護 */
/* Likert Scale Adjustments for Mobile */
@media(max-width: 480px) {
  .likert-row {
    margin: 16px 0;
    font-size: 14px; /* Ensure text fits better */
  }

  .scale-wrap {
    display: grid;
    grid-template-columns: repeat(7, 1fr); /* Equal width for each column */
    gap: 3px; /* Reduced gap to fit better */
    width: 100%;
    justify-items: center;
  }

  .scale label {
    font-size: 10px; /* Further reduce font size for small screens */
    flex-direction: column;
    align-items: center;
    text-align: center; /* Ensure label text is centered */
  }

  .scale input[type="radio"] {
    width: 16px;
    height: 16px; /* Adjust size of radio buttons */
  }

  .end-label {
    font-size: 10px; /* Reduce the end label font size */
    text-align: center; /* Ensure label text is centered */
  }
}
</style>
</head>
<body>
  <h1>光語言感知 _ 主觀感受問卷調查</h1>

  <div class="container">
    <!-- 同意 -->
    <section id="step0" class="card consent">
      <h3>研究說明與同意</h3>
      <p>您好，感謝您協助本研究之問卷調查。本研究由 國立臺灣科技大學 色彩與照明科技研究所 進行，旨在探討不同年齡層對「光語言」（Light Language）之主觀感受與心理反應。問卷採匿名填答，資料僅供學術研究分析使用，填答約需 5～8 分鐘。感謝您的參與。</p>
      <label style="display:flex;gap:10px;margin-top:14px;align-items:center">
        <input id="consent" type="checkbox" style="width:20px;height:20px">
        <span>我已閱讀並同意上述說明，願意匿名參與本研究。</span>
      </label>
      <div class="btnbar" style="justify-content:flex-end">
        <button id="toStep1" class="btn primary" disabled>下一頁</button>
      </div>
    </section>

    <!-- 基本資料 -->
    <section id="step1" class="card" style="display:none">
      <h3>基本資料（匿名處理）</h3>
      <div class="row">
        <div class="field"><label>年齡</label>
          <select id="age"><option value="">請選擇</option><option>18 歲以下</option><option>18–24 歲</option><option>25–34 歲</option><option>35–44 歲</option><option>45–54 歲</option><option>55 歲以上</option></select>
        </div>
        <div class="field"><label>性別</label>
          <select id="gender"><option value="">請選擇</option><option>女性</option><option>男性</option><option>非二元性別</option><option>不便透露</option></select>
        </div>
        <div class="field"><label>平時使用檯燈之頻率</label>
          <select id="lampFreq"><option value="">請選擇</option><option>幾乎每天</option><option>每週數次</option><option>偶爾</option><option>幾乎不用</option></select>
        </div>
        <div class="field"><label>作答裝置</label>
          <select id="device"><option value="">請選擇</option><option>桌上型電腦</option><option>筆記型電腦</option><option>平板</option><option>手機</option></select>
        </div>
      </div>
      <div class="btnbar">
        <button id="back0" class="btn">上一步</button>
        <button id="toStep2" class="btn primary" disabled>下一頁</button>
      </div>
    </section>

    <!-- 模擬與作答 -->
    <section id="step2" style="display:none">
      <div class="card" style="display:flex;justify-content:space-between;align-items:center">
        <span class="badge" id="sceneBadge">請先觀看畫面中光照之<strong>亮度、色溫與節律</strong>變化，並根據您的<strong>即時主觀感受</strong>作答。作答無對錯之分。</span>
        <span style="color:var(--muted);font-size:14px"><span id="progressText">0</span> / 12</span>
      </div>

      <div class="stage" id="stage">
        <img class="base" src="https://raw.githubusercontent.com/Judith-2000-Xin/light_language_V2/main/lamp_simulate_screen_V2.png" alt="底圖" />
        <div class="overlay">
          <div id="wall"   class="wall"></div>
          <div id="cone"   class="cone"></div>
          <div id="spot"   class="spot"></div>
          <div id="lamp"   class="lamp"></div>
          <div id="drawer" class="drawer"></div>
        </div>
      </div>
      <div class="timewrap"><div id="timebar" class="timebar"></div></div>

      <div class="card">
        <p style="color:var(--muted);font-size:14px;margin:0 0 12px;text-align:center;">
          本問卷採 7 點量表（1=非常不同意，7=非常同意）。
        </p>
        <form id="form">
          <div class="likert-row"><div class="likert-head">此照明情境的節奏變化或色溫轉換能提醒我回到當前任務。</div><div class="scale-wrap"><span class="end-label">非常不同意</span><div class="scale" data-q="q1"></div><span class="end-label">非常同意</span></div></div>
          <div class="likert-row"><div class="likert-head">此照明情境的穩定亮度與色調讓我感到平靜並能持續專注。</div><div class="scale-wrap"><span class="end-label">非常不同意</span><div class="scale" data-q="q2"></div><span class="end-label">非常同意</span></div></div>
          <div class="likert-row"><div class="likert-head">此照明情境的漸暗與暖調轉換讓我感到結束或休息的氛圍。</div><div class="scale-wrap"><span class="end-label">非常不同意</span><div class="scale" data-q="q3"></div><span class="end-label">非常同意</span></div></div>
          <!-- 這裡修正 class：lik頭 -> likert-head -->
          <div class="likert-row"><div class="likert-head">此照明情境的柔和與暖色感使我感到被安撫與放鬆。</div><div class="scale-wrap"><span class="end-label">非常不同意</span><div class="scale" data-q="q4"></div><span class="end-label">非常同意</span></div></div>
          <div class="likert-row"><div class="likert-head">此照明情境的亮度或閃爍頻率讓我感到緊繃或不適。</div><div class="scale-wrap"><span class="end-label">非常不同意</span><div class="scale" data-q="q5"></div><span class="end-label">非常同意</span></div></div>

          <div class="btnbar">
            <button type="button" id="prevBtn" class="btn" disabled>上一頁</button>
            <button type="button" id="nextBtn" class="btn primary">下一頁</button>
          </div>
        </form>
      </div>
    </section>

    <!-- 感謝頁 -->
    <section id="thanks" class="card" style="display:none">
      <h3><strong>感謝您的作答！</strong></h3>
      <p style="color:var(--muted);line-height:1.9">
        您寶貴的回覆已成功送出，以匿名方式保存於研究資料庫。<br/>
        本問卷僅用於學術研究與統計分析，不涉及任何個人辨識。
      </p>
    </section>
  </div>

<script>
/* ================== 基本設定 ================== */
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbzOix8oLWnmNSLN3P2y24l8xThNvygnbnWKXP3pw5a98j2k91h6giBqrUzvGv7jN3wh/exec";
const FORCE_COMPLETE_ON_ERROR=true;

const BASE_COLORS={9802:{r:180,g:200,b:255},1816:{r:255,g:190,b:120},3331:{r:255,g:230,b:200}};
const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
const normalize=([a,b,c])=>{const s=a+b+c;return s?[a/s,b/s,c/s]:[0,0,0]};
const lerp=(a,b,t)=>a+(b-a)*t;
const mix3=(A,B,t)=>[lerp(A[0],B[0],t),lerp(A[1],B[1],t),lerp(A[2],B[2],t)];
const mixColor=r=>{const [w1,w2,w3]=normalize(r);const c1=BASE_COLORS[9802],c2=BASE_COLORS[1816],c3=BASE_COLORS[3331];
 return{r:Math.round(w1*c1.r+w2*c2.r+w3*c3.r),g:Math.round(w1*c1.g+w2*c2.g+w3*c3.g),b:Math.round(w1*c1.b+w2*c2.b+w3*c3.b)}};
const rgba=(c,a)=>`rgba(${c.r},${c.g},${c.b},${a})`;

/* ============ 場景定義（固定配置，稍後洗牌） ============ */
const SCENES_RAW=[
  {id:"Q1-深度學習", ratio:[100,0,0],   intensity:1.00, animation:"none",  cycleSec:12},
  {id:"Q1-高效工作", ratio:[100,7,16], intensity:0.95, animation:"none",  cycleSec:12},
  {id:"Q1-日常事務", ratio:[100,0,72], intensity:0.85, animation:"none",  cycleSec:12},
  {id:"Q2-色溫引導", ratio:[97,15,100], ratioB:[27,52,100], intensity:0.85, animation:"ramp",   cycleSec:10},
  {id:"Q2-溫和脈衝", ratio:[68,20,100], intensity:0.80, animation:"pulse",  freq:0.4, amp:0.35, cycleSec:10},
  {id:"Q2-光束聚焦", ratio:[100,0,60], intensity:0.90, animation:"pulse",   freq:1.0, amp:0.40, cycleSec:10},
  {id:"Q2-氣氛轉換", ratio:[2,100,0], ratioB:[30,46,100],  intensity:0.75, animation:"ramp",   cycleSec:8},
  {id:"Q3-溫柔強制(→熄燈)", ratio:[20,81,100], intensity:0.70, animation:"powerdown", cycleSec:8, holdBlack:1, warmupSec:0},
  {id:"Q3-晚安序列(→熄燈)", ratio:[2,100,0],   intensity:0.60, animation:"powerdown", cycleSec:8, holdBlack:1, warmupSec:0},
  {id:"Q4-日落提醒", ratio:[14,100,100], ratioB:[97,15,100], intensity:0.85, animation:"ramp", cycleSec:10},
  {id:"Q4-呼吸光暈", ratio:[4,100,63],  intensity:0.70, animation:"breath", freq:0.42, amp:0.50, cycleSec:12},
  {id:"Q4-番茄時鐘", ratio:[6,100,77], ratioB:[100,1,36], intensity:1.0, animation:"pomodoro",
   flashes:5, onDur:0.25, offDur:0.35, holdSec:5, cycleSec:8}
];

/* ============ DOM 與狀態 ============ */
const step0=document.getElementById('step0');
const step1=document.getElementById('step1');
const step2=document.getElementById('step2');
const thanks=document.getElementById('thanks');
const consent=document.getElementById('consent');
const toStep1=document.getElementById('toStep1');
const toStep2=document.getElementById('toStep2');
const back0=document.getElementById('back0');

const age=document.getElementById('age');
const gender=document.getElementById('gender');
const lampFreq=document.getElementById('lampFreq');
const device=document.getElementById('device');

const stage=document.getElementById('stage');
const wall=document.getElementById('wall'); const cone=document.getElementById('cone');
const spot=document.getElementById('spot'); const lamp=document.getElementById('lamp');
const drawer=document.getElementById('drawer'); const timebar=document.getElementById('timebar');

const sceneBadge=document.getElementById('sceneBadge'); const progressText=document.getElementById('progressText');
const form=document.getElementById('form'); const prevBtn=document.getElementById('prevBtn'); const nextBtn=document.getElementById('nextBtn');

/* 提醒文字常數（避免每 frame 產生新字串） */
const TEXT_DEFAULT = `請先觀看照明模擬情境之<strong>亮度、色溫與節律</strong>變化，並根據您的<strong>即時主觀感受</strong>作答。無對錯之分。`;
const TEXT_Q1 = `請先觀看照明模擬情境<strong>(無動畫)</strong>，並根據您的<strong>即時主觀感受</strong>作答。無對錯之分。`;

let participant_id = (crypto.randomUUID? crypto.randomUUID(): Math.random().toString(36).slice(2));
let seed = Math.floor(Math.random()*1e9);
let SCENES = SCENES_RAW.slice();
shuffleInPlace(SCENES, seed);                // 隨機且可用 seed 重現
let order_ids = SCENES.map(s=>s.id).join('|');
let idx = 0, answers = [], rafId = 0, t0 = 0, sceneStartTs = 0;
let surveyStartTs = new Date().toISOString();

/* ============ 同意/基本資料 gating ============ */
function updateConsent(){ toStep1.disabled = !consent.checked; }
['change','click','input','keyup'].forEach(ev=>consent.addEventListener(ev,updateConsent));
updateConsent();
toStep1.addEventListener('click',()=>{ if(!consent.checked) return; step0.style.display='none'; step1.style.display='block'; });

function okBasic(){ return age.value && gender.value && lampFreq.value && device.value; }
function updateS1(){ toStep2.disabled = !okBasic(); }
[age,gender,lampFreq,device].forEach(el=>el.addEventListener('change',updateS1));
updateS1();
back0.addEventListener('click',()=>{ step1.style.display='none'; step0.style.display='block'; });
toStep2.addEventListener('click',()=>{ if(!okBasic()) return; step1.style.display='none'; step2.style.display='block'; calibrate(); });

/* ============ Likert 建立 ============ */
(function buildLikert(){
  document.querySelectorAll('.scale').forEach(box=>{
    const q=box.dataset.q; let s='';
    for(let i=1;i<=7;i++) s+=`<label><input type="radio" name="${q}" value="${i}"><span style="color:var(--muted);font-size:12px">${i}</span></label>`;
    box.innerHTML=s;
  });
})();

/* ============ 渲染層 ============ */
const Aalpha = v => Math.max(0, Math.min(1, v ?? 0));
const BASE_TX = {spot:'translate(-50%,-50%) rotate(-10deg)', lamp:'rotate(-22deg)'};

function renderWall(color, I){
  const a = Aalpha(I);

  // 牆面中心（依你的場景，燈罩大約在畫面 36% x / 23% y）
  const CX = 0.36, CY = 0.23;

  // 主圓形漫射：超大半徑 + 多段 stop 做平滑 roll-off
  const radial =
    `radial-gradient(circle at ${CX*100}% ${CY*100}%,
      ${rgba(color, 0.16*a)}  0%,
      ${rgba(color, 0.10*a)} 22%,
      ${rgba(color, 0.06*a)} 45%,
      ${rgba(color, 0.03*a)} 70%,
      rgba(0,0,0,0)         92%)`;

  // 縱向淡淡的頂部漫射：避免只剩一顆亮塊
  const vertical =
    `linear-gradient(to bottom,
      ${rgba(color, 0.10*a)} 0%,
      ${rgba(color, 0.05*a)} 22%,
      rgba(0,0,0,0)         55%)`;

  wall.style.background = `${radial}, ${vertical}`;
  wall.style.opacity = 1;
}
function renderCone(color, I, shape){
  const a = Aalpha(I);
  document.documentElement.style.setProperty('--spot-color', rgba(color, 0.92*a));
  cone.style.opacity = a;
  const sy = shape ? shape.sy : 1;
  cone.style.transform = `scaleY(${sy})`;
}
function renderSpot(color, I, shape){
  const a = Aalpha(I);
  spot.style.background = `radial-gradient(closest-side, ${rgba(color,0.95*a)} 0%, ${rgba(color,0.28*a)} 70%, rgba(0,0,0,0) 100%)`;
  const sx = shape ? shape.sx : 1, sy = shape ? shape.sy : 1;
  spot.style.transform = `${BASE_TX.spot} scale(${sx},${sy})`;
  spot.style.opacity = a;
}
function renderLamp(color, I){
  const a = Aalpha(I);
  lamp.style.background = `radial-gradient(closest-side, ${rgba(color,0.9*a)}, rgba(0,0,0,0))`;
  lamp.style.transform  = BASE_TX.lamp;
  lamp.style.opacity    = .6 * a;
  drawer.style.opacity  = .75 * a;
}

/* ============ 動畫引擎 ============ */
function animatedState(scene,t){
  const cyc = scene.cycleSec || 12;
  const baseI = scene.intensity ?? 0.8;
  const f = scene.freq ?? 0.5;
  const A = clamp(scene.amp ?? 0.3, 0, 1);

  let ratio = scene.ratio.slice();
  let I = baseI;
  let shape = {sx:1, sy:1};

  switch(scene.animation){
    case "breath": {
      const s = (Math.sin(2*Math.PI*f*t)+1)/2;
      I = baseI * (0.80 + 0.35*A*s);
      shape = { sx: 1 + 0.18*A*s, sy: 1 + 0.30*A*s };
      break;
    }
    case "pulse": {
      const s = Math.sin(2*Math.PI*f*t);
      const sharp = Math.pow(Math.max(0,s),2.2);
      I = baseI*(1-0.5*A + A*sharp);
      break;
    }
    case "ramp": {
      const s = (Math.sin(2*Math.PI*(1/cyc)*t)+1)/2;
      if(scene.ratioB) ratio = mix3(normalize(scene.ratio), normalize(scene.ratioB), s);
      break;
    }
    case "flicker": {
      const s = (Math.sin(2*Math.PI*f*t)+Math.sin(2*Math.PI*(f*1.618)*t))/2;
      I = baseI*(1+0.15*A*s);
      break;
    }
    case "powerdown": {
      const hold = scene.holdBlack ?? 3;
      const T = cyc + hold;
      const p = t % T;
      I = (p <= cyc) ? baseI*(1-p/cyc) : 0;
      break;
    }
    case "pomodoro": {
      const flashes = scene.flashes ?? 5;
      const on = scene.onDur ?? 0.25;
      const off = scene.offDur ?? 0.35;
      const flashTotal = flashes*(on+off);
      const hold = scene.holdSec ?? 5;
      const T = flashTotal + hold;
      const p = t % T;

      if (p < flashTotal){
        ratio = scene.ratio.slice();
        const q = p % (on+off);
        I = (q < on) ? baseI : baseI*0.08;
      } else {
        ratio = (scene.ratioB || scene.ratio).slice();
        I = baseI;
      }
      break;
    }
    case "none": default: break;
  }
  return {ratio, intensity:clamp(I,0,1), shape};
}

function renderFrame(scene,t){
  let {ratio,intensity,shape} = animatedState(scene,t);
  if (scene.warmupSec){ intensity *= Math.min(1, t / scene.warmupSec); }

  const color=mixColor(ratio);
  renderWall(color,intensity); renderCone(color,intensity,shape);
  renderSpot(color,intensity,shape); renderLamp(color,intensity);

  // 左上提醒文字
  sceneBadge.innerHTML = scene.id.startsWith('Q1-') ? TEXT_Q1 : TEXT_DEFAULT;

  // timebar
  const cyc= (scene.animation==="pomodoro")
              ? ((scene.flashes??5)*((scene.onDur??0.25)+(scene.offDur??0.35)) + (scene.holdSec??5))
              : (scene.cycleSec+(scene.holdBlack||0));
  timebar.style.width=`${((t%cyc)/cyc)*100}%`;
}

function startAnimation(scene){
  cancelAnimationFrame(rafId); t0=performance.now();
  (function loop(now){const t=(now-t0)/1000; renderFrame(scene,t); rafId=requestAnimationFrame(loop)})(t0);
}

/* ============ 洗牌（可重現版本，保留 seed） ============ */
function shuffleInPlace(arr, seedValue){
  let m=0x80000000, a=1103515245, c=12345;
  let state = (seedValue>>>0) || (Math.random()*m)|0;
  function rand(){ state=(a*state+c)%m; return state/m; }
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(rand()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
}

/* ============ 問卷流程 ============ */
function loadScene(k){
  const s=SCENES[k];
  progressText.textContent=`${k+1} / ${SCENES.length}`;
  ['q1','q2','q3','q4','q5'].forEach(q=>form.querySelectorAll(`input[name="${q}"]`).forEach(n=>n.checked=false));
  prevBtn.disabled=(k===0);
  nextBtn.textContent=(k===SCENES.length-1)?"送出":"下一頁";
  startAnimation(s);
  sceneStartTs = performance.now();
}
loadScene(idx);

function collectCurrent(){
  const s=SCENES[idx];
  const rec={sceneId:s.id, ratio:normalize(s.ratio)};
  for(const q of ['q1','q2','q3','q4','q5']){
    const n=form.querySelector(`input[name="${q}"]:checked`);
    if(!n) return null;
    rec[q]=+n.value;
  }
  rec.order_index = idx+1;
  rec.intensity   = s.intensity ?? 0;
  rec.animation   = s.animation || "none";
  rec.cycleSec    = s.cycleSec || 0;
  rec.rt_ms       = Math.round(performance.now() - sceneStartTs);
  return rec;
}
prevBtn.addEventListener('click',()=>{ if(idx>0){ idx--; loadScene(idx); } });
nextBtn.addEventListener('click',async()=>{
  const rec=collectCurrent(); if(!rec){ alert('請完成本頁五題評分（1~7）。'); return; }
  answers[idx]=rec;
  if(idx===SCENES.length-1){
    let ok=false;
    try{ await submitToSheet(answers); ok=true; }
    catch(e){ console.warn('送出到試算表失敗：',e); if(FORCE_COMPLETE_ON_ERROR) ok=true; }
    if(ok){ step2.style.display='none'; thanks.style.display='block'; cancelAnimationFrame(rafId); }
  }else{ idx++; loadScene(idx); }
});

/* ============ 送出到 Google Apps Script ============ */
async function submitToSheet(rows){
  if(!SCRIPT_URL || SCRIPT_URL.startsWith("REPLACE_")) throw new Error("尚未設定 SCRIPT_URL");

  const payload = {
    meta:{
      participant_id,
      seed,
      order: order_ids,
      start_ts: surveyStartTs,
      end_ts: new Date().toISOString(),
      age: age.value, gender: gender.value, lampFreq: lampFreq.value, device: device.value
    },
    rows: rows.map(r=>({
      participant_id,
      order_index: r.order_index,
      sceneId: r.sceneId,
      r9802: r.ratio[0], r1816: r.ratio[1], r3331: r.ratio[2],
      intensity: r.intensity,
      animation: r.animation,
      cycleSec: r.cycleSec,
      q1: r.q1, q2: r.q2, q3: r.q3, q4: r.q4, q5: r.q5,
      rt_ms: r.rt_ms
    }))
  };

  // 關鍵：使用 text/plain，避免 CORS 預檢（OPTIONS）
  const res = await fetch(SCRIPT_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
    body: JSON.stringify(payload)
  });

  // 下面保留檢查與偵錯
  if (!res.ok) {
    const text = await res.text().catch(()=>'(no body)');
    console.error('GAS HTTP error', res.status, text);
    throw new Error(`HTTP ${res.status}`);
  }
  const data = await res.json().catch(async () => {
    // 如果後端回傳 text/plain 也能處理
    const t = await res.text();
    try { return JSON.parse(t); } catch { return {status:'error', message:'非 JSON 回應: '+t}; }
  });
  console.log('GAS response:', data);
  if (data.status !== 'ok') throw new Error('GAS 回傳非 ok');
}

/* ============ 自適應校正（resize） ============ */
function calibrate(){
  const r=stage.getBoundingClientRect(); const ar=r.width/r.height;
  const t = clamp((ar-1.5)/(1.9-1.5), 0, 1);

  setVar('--wall-left',10); setVar('--wall-top', lerp(15,5,t));
  setVar('--wall-w', lerp(95,80,t)); setVar('--wall-h', lerp(55,45,t));

  setVar('--lamp-left', lerp(24,34,t)); setVar('--lamp-top', lerp(25,35,t));
  setVar('--lamp-w', lerp(25,1,t)); setVar('--lamp-h', lerp(12,2,t));

  setVar('--spot-left', lerp(50,46,t)); setVar('--spot-top', lerp(86,84,t));
  setVar('--spot-w', lerp(40,36,t)); setVar('--spot-h', lerp(22,20,t));

  setVar('--cone-h', lerp(70,65,t));

  const base = Math.min(r.width, r.height);
  document.documentElement.style.setProperty('--wall-blur',  (base*0.03/10)+'vw');
  document.documentElement.style.setProperty('--cone-blur',  (base*0.022/10)+'vw');
  document.documentElement.style.setProperty('--spot-blur',  (base*0.018/10)+'vw');
  document.documentElement.style.setProperty('--lamp-blur',  (base*0.009/10)+'vw');
}
function setVar(name,val){ document.documentElement.style.setProperty(name, typeof val==='number' ? `${val}%` : val); }
window.addEventListener('resize', calibrate);
window.addEventListener('orientationchange', calibrate);
calibrate();
</script>
</body>
</html>
